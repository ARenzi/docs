# Enabling Google authentication in iOS apps
{: #google-auth-ios}

## Before you begin
{: #google-auth-ios-before}
* You must have a resource that is protected by {{site.data.keyword.amashort}} and an iOS project that is instrumented with the {{site.data.keyword.amashort}} Client SDK.  For more information, see [Getting started with {{site.data.keyword.amashort}}](getting-started.html) and [Setting up the iOS SDK](getting-started-ios.html).  
* Manually protect your backend application with {{site.data.keyword.amashort}} Server SDK. For more information, see [Protecting resources](protecting-resources.html).


## Configuring a Google Project for the iOS Platform
{: #google-auth-ios-project}
To start using Google as identity provider, create a project in the Google Developer Console to obtain a Google client ID.  This client ID is a unique identifier to let Google know which application is attempting to connect.   If you already have Google project, you can skip the steps that describe project creation and start with adding credentials.

1. Open the [Google Developer Console](https://console.developers.google.com).

1. Create a project. Click **Create project**.

1. Select your project and click **Use Google APIs**. You might also click **Enable APIs and get credentials like keys**.

1. In the API list, choose the Google+ API and click **Enable API**.

1. Click **Credentials > Add credentials** and select **OAuth 2.0 client ID**.

1. You might be asked to set a product name on the consent console. Proceed to do so.

1. At this point you will be presented with an application type choice. Select **iOS**.

1. Provide a meaningful name for your iOS client. Specify the bundleId of your iOS application. To find the bundleId of your iOS application look for **Bundle Identifier** in either the `info.plist` file or the Xcode project **General** tab.

1. Take a note of your new iOS Client ID. You need the value when you set up the application in  {{site.data.keyword.Bluemix_notm}}.


## Configuring {{site.data.keyword.amashort}} for Google authentication
{: #google-auth-ios-config}

Now that you have an iOS Client ID, you can enable Google authentication in the {{site.data.keyword.Bluemix_notm}} dashboard.

1. Open {{site.data.keyword.Bluemix}} Dashboard and click on your {{site.data.keyword.Bluemix_notm}} Application

1. Click **Mobile Options** and take note of *applicationRoute* and *applicationGUID* values. You need these values to initialize the SDK.

1. Click on a {{site.data.keyword.amashort}} tile

1. You will reach {{site.data.keyword.amashort}} Dashboard

1. Click **Set up authentication**

1. Click **Google**

1. Specify the Client ID for iOS obtained obtained in previous steps and click **Save**

## Configuring {{site.data.keyword.amashort}} Client SDK for iOS
{: #google-auth-ios-sdk}

### Installing the {{site.data.keyword.amashort}} Client SDK using Cocoapods
{: #google-auth-ios-sdk-cocoapods}

1. Navigate to your iOS projet

1. Edit the `Podfile` and add below line to required target

	```
	pod 'IMFGoogleAuthentication'
	```

1. Save `Podfile` and run `pod install` from the command line

1. Cocoapods will install added dependencies. You will see the progress and which components were added.

	> From this point on you will always need to open your project by using a xcworkspace file generated by Cocoapods. Usually the name is {your-project-name}.xcworkspace.  

1. Run `open {your-project-name}.xcworkspace` from command line to open our iOS project workspace

### Configuring iOS project for Google Authentication
{: #google-auth-ios-googleauth}

1. Find the `info.plist` file, usually located under `Supporting files` folder in your Xcode project

1. Configure Google integration by adding the two below URL schemes to your `info.plist` file

	![image](images/ios-google-infoplist-settings.png)

	> The first URL Schema is reversed Client ID you got from Google Developer Console. E.g. if your Client ID is `123123-abcabc.apps.googleusercontent.com` your URL Schema should be `com.googleusercontent.apps.123123-abcabc`

	> The second URL Schema is a bundle Id of your application

1. Alternatively you can update the `info.plist` file by right-clicking it, selecting `Open as` -> `Source code` and adding below XML

	```XML
	<key>CFBundleURLTypes</key>
	<array>
		<dict>
			<key>CFBundleTypeRole</key>
			<string>Editor</string>
			<key>CFBundleURLSchemes</key>
			<array>
				<string>com.googleusercontent.apps.123123-abcabc</string>
			</array>
		</dict>
		<dict>
			<key>CFBundleTypeRole</key>
			<string>Editor</string>
			<key>CFBundleURLSchemes</key>
			<array>
				<string>com.ibm.HelloWorld</string>
			</array>
		</dict>
	</array>

	```
	> Update both URL Schemas as described above

	> Make sure you're not overriding any existing properties in `info.plist`. If you have overlapping properties you will need to merge manually. Refer to [Try Sign-In for iOS](https://developers.google.com/identity/sign-in/ios/start) sections of Google documentation for additional information.

## Initializing the {{site.data.keyword.amashort}} Client SDK
{: #google-auth-ios-initialize}

In order to be able to use the {{site.data.keyword.amashort}} Client SDK you need to initialize it by passing the applicationGUID, and applicationRoute parameters.

> A common, though not mandatory, place to put the initialization code is in the `application:didFinishLaunchingWithOptions` method of your application delegate

1. Open the main page of the {{site.data.keyword.Bluemix_notm}} Dashboard and click the previously created app. This will open your mobile backend app dashboard.

2. Click `Mobile Options` in the top right part of the dashboard. The Application Route and Application GUID values will be displayed.

1. Import required framework in the class you want to use {{site.data.keyword.amashort}} Client SDK by adding  below headers

	Objective-C applications:

	```Objective-C
	#import <IMFCore/IMFCore.h>
	#import <IMFGoogleAuthentication/IMFGoogleAuthenticationHandler.h>
	```

	Swift applications:

	{{site.data.keyword.amashort}} Client SDK is implemented using Objective-C, therefore you might need to add a bridging header to your swift project in order to be able to use it.

	* Right-click your project in Xcode and select `New File...`
	* In the `iOS Source` category pick `Header file`
	* Name it `BridgingHeader.h`
	* Add below imports to your bridging header

	```Objective-C
	#import <IMFCore/IMFCore.h>
	#import <IMFGoogleAuthentication/IMFGoogleAuthenticationHandler.h>
	```
	* Click your project in Xcode and select `Build Settings` tab
	* Search for `Objective-C Bridging Header`
	* Set the value to location of your `BridgingHeader.h` file, e.g. `$(SRCROOT)/MyApp/BridgingHeader.h`
	* Make sure your bridging header is being picked up by Xcode by building your project, you should see no failure messages

3. Use below code to initialize the Client SDK

	Objective-C applications:

	```Objective-C
	[[IMFClient sharedInstance]
			initializeWithBackendRoute:@"applicationRoute"
			backendGUID:@"applicationGUID"];
	```

	Swift applications:

	```Swift
	IMFClient.sharedInstance().initializeWithBackendRoute("applicationRoute",
	 							backendGUID: "applicationGUID")
	```

	> Replace the applicationRoute and applicationGUID with values obtained from Mobile Options

1. Register Google Authentication Handler by adding below code to `application:didFinishLaunchingWithOptions` method in your app delegate. It is recommended to do this right after you initialized the IMFClient

	Objective-C applications:

	```Objective-C
	[[IMFGoogleAuthenticationHandler sharedInstance] registerWithDefaultDelegate];
	```

	Swift applications:

	```Swift
	IMFGoogleAuthenticationHandler.sharedInstance().registerWithDefaultDelegate()
	```

1. Add below code to your app delegate

	Objective-C applications:

	```Objective-C
	- (void)applicationDidBecomeActive:(UIApplication *)application {
		[[IMFGoogleAuthenticationHandler sharedInstance] handleDidBecomeActive];
	}

	- (BOOL)application: (UIApplication *)application openURL: (NSURL *)url
					sourceApplication: (NSString *)sourceApplication annotation: (id)annotation {

		BOOL shouldHandleGoogleURL = [GPPURLHandler handleURL:url
					sourceApplication:sourceApplication annotation:annotation];

		[[IMFGoogleAuthenticationHandler sharedInstance] handleOpenURL:shouldHandleGoogleURL];
		return  shouldHandleGoogleURL;
	}
	```

	Swift applications:

	```Swift
	func application(application: UIApplication, openURL url: NSURL,
					sourceApplication: String?, annotation: AnyObject) -> Bool {

		let shouldHandleGoogleURL = GPPURLHandler.handleURL(url,
				sourceApplication: sourceApplication, annotation: annotation)

		IMFGoogleAuthenticationHandler.sharedInstance()
							.handleOpenURL(shouldHandleGoogleURL)

		return shouldHandleGoogleURL;
	}
```

## Testing the authentication
{: #google-auth-ios-testing}
After the Client SDK is initialized, you can start making requests to your mobile backend.

### Before you begin
{: #google-auth-ios-testing-before}
You must be using the {{site.data.keyword.mobilefirstbp}} boilerplate and already have a resource protected by {{site.data.keyword.amashort}} at the `/protected` endpoint. If you need to set up a `/protected` endpoint, see [Protecting resources](protecting-resources.html).


1. Try to send a request to protected endpoint of your mobile backend in your desktop browser by opening `http://{appRoute}/protected`, for example `http://my-mobile-backend.mybluemix.net/protected`

1. The `/protected` endpoint of a mobile backend created with MobileFirst Services Boilerplate is protected with {{site.data.keyword.amashort}}, therefore it can only be accessed by mobile applications instrumented with {{site.data.keyword.amashort}} Client SDK. As a result you will see `Unauthorized` in your desktop browser.

1. Use your iOS application to make request to the same endpoint.

	Objective-C:

	```Objective-C
	NSString *requestPath = [NSString stringWithFormat:@"%@/protected",
								[[IMFClient sharedInstance] backendRoute]];

	IMFResourceRequest *request =  [IMFResourceRequest requestWithPath:requestPath
																method:@"GET"];

	[request sendWithCompletionHandler:^(IMFResponse *response, NSError *error) {
		if (error){
			NSLog(@"Error :: %@", [error description]);
		} else {
			NSLog(@"Response :: %@", [response responseText]);
			NSLog("%@", IMFAuthorizationManager.sharedInstance().userIdentity)
		}
	}];
	```

	Swift:

	```Swift
	let requestPath = IMFClient.sharedInstance().backendRoute + "/protected"

	let request = IMFResourceRequest(path: requestPath, method: "GET");
	request.sendWithCompletionHandler { (response, error) -> Void in
		if (nil != error){
			NSLog("Error :: %@", error.description)
		} else {
			NSLog("Response :: %@", response.responseText)
			NSLog("%@", IMFAuthorizationManager.sharedInstance().userIdentity)
		}
	};

	```

1. Run your application. You will see a Google Login screen pop-up

	![image](images/ios-google-login.png)

	This screen might look slightly different if you do not have the Facebook app installed on your device, or if you are not currently logged in to Facebook.

1. By clicking **OK** you're authorizing {{site.data.keyword.amashort}} to use your Google user identity for authentication purposes.

1. 	Your request should succeed. You should see the following output in the LogCat

	![image](images/ios-google-login-success.png)
